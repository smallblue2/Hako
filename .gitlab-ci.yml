default:
  image: emscripten/emsdk:4.0.0

stages:
  - lint
  - build
  - validate
  - test

lint_filesystem_js:
  stage: lint
  script:
    - cd src/filesystem
    - npm install
    - npm run lint

lint_filesystem_c:
  stage: lint
  script:
    - cd src/filesystem
    - apt-get update && apt-get -y install clang-tidy cppcheck
    - make lint

lint_filesystem_tests:
  stage: lint
  script:
    - cd src/filesystem
    - npm install
    - npm run lint-tests

lint_processes:
  stage: lint
  script:
    - cd src/processes
    - npm install
    - npm run lint
  
build_filesystem:
  stage: build
  script:
    - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin/
    - apt-get update
    - apt-get install -y meson
    - just filesystem
  # Artifacts are to be kept between jobs
  artifacts:
    paths:
      - build/filesystem/
    expire_in: 1 week

build_runtime:
  stage: build
  script:
    - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin/
    - apt-get update
    - apt-get install -y meson
    - just runtime
  # Artifacts are to be kept between jobs
  artifacts:
    paths:
      - build/runtime/
    expire_in: 1 week

validate_artefact_persistence:
  stage: validate
  dependencies:
    - build_filesystem
  script:
    # Ensure artifacts have persisted
    - test -e build/filesystem/filesystem.js
    - test -e build/filesystem/filesystem.wasm
    - test -e build/filesystem/index.html
    - test -e build/filesystem/index.js
    - test -e build/filesystem/api.js
    - test -e build/filesystem/definitions.js
    - test -e build/filesystem/filesystem.js
    - test -e build/filesystem/filesystem.wasm

validate_wasm:
  stage: validate
  dependencies:
    - build_filesystem
  script:
    - apt-get update && apt-get install -y wabt
    - wasm-validate --enable-threads build/filesystem/filesystem.wasm

test_filesystem:
  stage: test
  script:
    - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin/
    - apt-get update
    - apt-get install -y ca-certificates wget xdg-utils chromium-browser libgbm1 meson nq
    - cd src/filesystem && npm install
    - PATH=$PATH:/root/.deno/bin/ just test-filesystem

test_runtime:
  stage: test
  script:
    - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin/
    - apt-get update
    - apt-get install -y chromium-browser meson
    - just test-runtime
